# Express の高度な使い方

## ユーザー認証

- 登録ユーザーの保存と認証を行うロジック
- ユーザー登録機能
- ログイン機能
- ログインしたユーザーのリクエストに応じてユーザー情報をロードするミドルウェア


### ユーザー情報の保存と読み出し

- アプリケーションの依存ファイルを package.json ファイルで定義する
- ユーザーモデルを作成する
- ユーザーデータを Redis でロード/セーブするロジックを追加
- ユーザーのパスワードを bcrypt で保護する
- ログイン認証を行うロジックを追加する

bcypct は、パスワードのハッシング専用に設計された「ソルテッドハッシュ関数」

- [レインボーテーブル攻撃]()

__redic-cli__

```bash
$ redis-server
$ redis-cli
```

### 新規ユーザー登録

- 登録とログインの経路をURLパスにマップする
- 登録フォームを表示する経路のロジックを追加する
- フォームで送信されたユーザー情報を保存するロジックを追加する

### 登録済みユーザーをログインさせる

- ログインフォーム表示経路のロジック
- フォームから提出されたユーザーデータを認証するロジック

__認証済みユーザーと匿名ユーザーのためのメニューを作る__

- サインイン(login)
- ユーザー登録(register)
- エントリーの投稿(post)
- ログアウト(logout)

- 投稿するページへのリンク(post)
- ログアウト(logout)


## 高度なルーティング技術

- 経路ごとのミドルウェアを使って、ユーザーが提出したコンテンツを検証する
- 特定の経路で実行される妥当性検証の実装
- ページ付けの実装

### ユーザーが提出したコンテンツの妥当性を検証する


### ページ付けを実装する

__URLでの明確なページ指定を実現する__

`?page=2` のようなパラメータを使わずに、`/entries/2` というようなパス名を使う場合

1. 経路パスを、ページ番号を受け取るように変更する
2. ページのテンプレートを変更する

`/:page` 文字列を渡す。
（経路パラメータ route parameter と呼ぶ）


## パブリックな REST API を作る

REST(Representational) は、「HTTPメソッドを動詞、URLを名刺とする表現で、アプリケーションデータの問い合わせと変更ができるようにしよう」というアイデアで
そのリクエストでは、データを(JSON や XML などの) マシンが読みやすい形式で返すのが一般的。

- ユーザがエントリーを表示/リストアップ/削除/ポストできるように、APIを設計する
- Basic 認証を追加する
- ルーティングを実装する
- JSON と XML のレスポンスを提供する

### API の設計

### Basic 認証の追加

### ルーティングの実装

```bash
# curl による auth 認証のテスト
$ curl http://user:pass@127.0.0.1:3000/api/user/1 -v

# curl による api 投稿のテスト
# タイトルと本体データをHTMLフォームと同じ name で送信
$ curl -F entry[title]="Ho ho ho" -F entry[body]="Santa loves you" http://aba:aba@127.0.0.1:3000/api/entry
# (multipart/data-form supported)
$ curl -d entry[title]="Ho ho ho" -d entry[body]="Santa loves you" http://aba:aba@127.0.0.1:3000/api/entry
# (HTTP POST)

# curl によるエントリー取得のテスト
$ curl http://user:pass@127.0.0.1:3000/api/entries
```

### コンテントネゴシエーションを有効にする

HTTP は Accept ヘッダーフィールドを介して、コンテントネゴシエーションの機構を提供できる。
たとえば「できればHTMLが良いが、プレーンテキストでもやむをえない」というものなら、リクエストヘッダを次のように設定できる。

```bash
Accept: text/plain; q=0.5, text/html
```
text/html は2番目に指定されているにもかかわらず、50%の割合で、text/plain より好ましい、という希望を表している。

__コンテントネゴシエーションの実装__

__XML応答__

```bash
$ curl -i -H 'Accept: application/xml' http://user:pass@127.0.0.1:3000/api/entries
```

## エラー処理

### 404 エラーを処理する

__エラー応答を返す経路を追加する__

__エラーページ用テンプレートの作成__

__404ミドルウェアを有効にする__


### 各種のエラーを処理する
